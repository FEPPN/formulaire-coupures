<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Formulaire Coupures</title>
</head>
<body>

<div style="max-width:620px;margin:40px auto;padding:32px;background:#fff;border-radius:20px;
            box-shadow:0 10px 30px rgba(0,0,0,0.07);font-family:'Segoe UI',sans-serif;color:#1a1a1a;">

  <h2 style="text-align:center;font-size:24px;font-weight:700;margin-bottom:30px;color:#5A52FF;">
    Signalez une coupure d’électricité dans votre ville
  </h2>

  <div style="position:relative;margin-bottom:28px;">
    <input id="ville" type="text" placeholder="Ex. : Lyon"
           style="width:100%;padding:14px 16px;border:2px solid #5A52FF;border-radius:10px;
                  font-size:16px;box-sizing:border-box;">
    <ul id="suggestions" style="
         list-style:none;margin:4px 0 0;padding:0;position:absolute;
         top:100%;left:0;right:0;background:#fff;border:1px solid #5A52FF;
         border-top:none;max-height:160px;overflow-y:auto;
         box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:100;display:none;
       "></ul>
  </div>

  <label style="font-weight:600;display:block;margin-bottom:12px;">Avez-vous eu une coupure ?</label>
  <div style="display:flex;gap:20px;margin-bottom:32px;">
    <label class="opt" data-value="Oui"
           style="flex:1;background:#F1F3FF;padding:14px 16px;border-radius:10px;
                  text-align:center;cursor:pointer;border:2px solid transparent;
                  transition:border-color .2s;">Oui</label>
    <label class="opt" data-value="Non"
           style="flex:1;background:#F1F3FF;padding:14px 16px;border-radius:10px;
                  text-align:center;cursor:pointer;border:2px solid transparent;
                  transition:border-color .2s;">Non</label>
  </div>

  <button id="submitBtn" style="
          width:100%;
          padding:16px;
          background: linear-gradient(to right, #5A52FF, #B3AFFF);
          color:#fff;
          border:none;
          border-radius:12px;
          font-size:17px;
          font-weight:bold;
          cursor:pointer;
          transition:opacity .3s;">
    Envoyer
  </button>

  <p id="confirmation" style="display:none;margin-top:20px;color:#5A52FF;
         text-align:center;font-weight:600;">Merci, votre réponse a bien été envoyée !</p>
</div>

<script>
  let cities = [], citiesNorm = [], choixCoupure = "";

  function normalize(str) {
    return str.normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '')
              .replace(/[-’']/g, ' ')
              .replace(/\s+/g, ' ')
              .trim()
              .toLowerCase();
  }

  document.addEventListener("DOMContentLoaded", () => {
    const input       = document.getElementById("ville");
    const suggestions = document.getElementById("suggestions");
    const opts        = document.querySelectorAll(".opt");
    const btn         = document.getElementById("submitBtn");

    // 1) Charger le JSON des communes
    fetch("https://FEPPN.github.io/formulaire-coupures/Communes.json")
      .then(r => r.json())
      .then(data => {
        cities     = data.map(c => c.nom);
        citiesNorm = cities.map(normalize);
      })
      .catch(console.error);

    // 2) Suggestions à chaque frappe
    input.addEventListener("input", () => {
      const qNorm = normalize(input.value);
      if (!qNorm) {
        suggestions.style.display = 'none';
        return;
      }
      const matches = citiesNorm
        .map((cn,i) => ({ cn, orig: cities[i] }))
        .filter(item => item.cn.includes(qNorm))
        .slice(0,5);
      suggestions.innerHTML = matches.map(item =>
        `<li style="padding:10px 14px;cursor:pointer;border-bottom:1px solid #eee;">
           ${item.orig}
         </li>`
      ).join("");
      suggestions.style.display = matches.length ? 'block' : 'none';
    });

    // 3) Sélection d’une suggestion
    suggestions.addEventListener("click", e => {
      if (e.target.tagName === 'LI') {
        input.value = e.target.textContent;
        suggestions.style.display = 'none';
      }
    });

    // 4) Choix Oui/Non
    opts.forEach(label => {
      label.addEventListener("click", () => {
        choixCoupure = label.dataset.value;
        opts.forEach(l => l.style.borderColor = "transparent");
        label.style.borderColor = "#5A52FF";
      });
    });

    // 5) Envoi avec timestamp client
    btn.addEventListener("click", () => {
      const villeRaw = input.value.trim();
      const qNorm    = normalize(villeRaw);
      if (!qNorm || !citiesNorm.includes(qNorm)) {
        alert("Merci de saisir et sélectionner une ville valide.");
        return;
      }
      if (!choixCoupure) {
        alert("Merci de répondre à la question.");
        return;
      }

      const index         = citiesNorm.indexOf(qNorm);
      const villeCorrecte = cities[index];
      const clientTs      = new Date().toISOString();

      fetch("https://script.google.com/macros/s/AKfycbzblxLJCOjzKsHZYdI2xEnpbH6ZFhRDsPgVZQqr-GB-MIjcVqiwZR-kge1jNA8MIII5IA/exec", {
        method: "POST",
        mode:   "no-cors",
        headers:{ "Content-Type": "application/json" },
        body:   JSON.stringify({
          timestamp: clientTs,
          ville:     villeCorrecte,
          coupure:   choixCoupure
        })
      });

      // reset + confirmation
      input.value = "";
      choixCoupure = "";
      opts.forEach(l => l.style.borderColor = "transparent");
      document.getElementById("confirmation").style.display = "block";
    });

    // 6) Fermer suggestions au clic extérieur
    document.addEventListener("click", e => {
      if (!e.target.closest('#ville')) {
        suggestions.style.display = 'none';
      }
    });
  });
</script>

</body>
</html>

